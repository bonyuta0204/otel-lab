# OtelLab - OpenTelemetry & Jaeger å®Ÿé¨“ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

[![Go Version](https://img.shields.io/badge/Go-1.21+-blue.svg)](https://golang.org)
[![Docker](https://img.shields.io/badge/Docker-20.10+-blue.svg)](https://docker.com)
[![OpenTelemetry](https://img.shields.io/badge/OpenTelemetry-1.21+-orange.svg)](https://opentelemetry.io)
[![Jaeger](https://img.shields.io/badge/Jaeger-Latest-yellow.svg)](https://jaegertracing.io)

OtelLabã¯ã€OpenTelemetryã¨Jaegerã‚’ä½¿ã£ãŸåˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã®å®Ÿè£…ã‚’å­¦ç¿’ã™ã‚‹ãŸã‚ã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¾‹ã«ã€å®Ÿéš›ã®åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã§ã®ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½“é¨“ã§ãã¾ã™ã€‚

## ğŸ¯ å­¦ç¿’ç›®æ¨™

- **åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã®åŸºç¤**: Context Propagationã€Spanç®¡ç†ã€ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æˆ¦ç•¥
- **ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³**: ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã€éšœå®³ã®ä¼æ’­ã¨éš”é›¢
- **è¦³æ¸¬æ€§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°**: ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚·ã‚°ãƒŠãƒ«ã€SLI/SLOè¨­å®š
- **Goè¨€èªã®å®Ÿè·µçš„æ´»ç”¨**: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ã€ä¸¦è¡Œå‡¦ç†ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API Gateway (:8080)                      â”‚
â”‚  - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»èªè¨¼ãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹ã®é–‹å§‹ç‚¹                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ gRPC                 â”‚ gRPC
              â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Task Service (:8081)  â”‚  â”‚   User Service (:8082)  â”‚
â”‚  - ã‚¿ã‚¹ã‚¯ç®¡ç†           â”‚  â”‚  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†         â”‚
â”‚  - PostgreSQLé€£æº       â”‚  â”‚  - ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä½¿ç”¨æŠ€è¡“

- **è¨€èª**: Go 1.21+
- **Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Gorilla Mux (API Gateway), gRPC (ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡)
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQL 15 (Task Service), ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª (User Service)
- **è¦³æ¸¬æ€§**: OpenTelemetry + Jaeger
- **ã‚¤ãƒ³ãƒ•ãƒ©**: Docker Compose

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### å‰ææ¡ä»¶

- Go 1.21+
- Docker & Docker Compose
- Make (æ¨å¥¨)

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# 1. ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/bonyuta0204/otel-lab.git
cd otel-lab

# 2. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« & ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ï¼ˆãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰ï¼ï¼‰
make quick-start
```

ã“ã‚Œã ã‘ã§å…¨ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¾ã™ï¼

### ç¢ºèª

```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
make health

# Jaeger UI ã‚’é–‹ã
make jaeger
# ã¾ãŸã¯ç›´æ¥: http://localhost:16686

# ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
make demo
```

## ğŸ“š API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### ã‚¿ã‚¹ã‚¯ç®¡ç†

```bash
# ã‚¿ã‚¹ã‚¯ä½œæˆ
curl -X POST http://localhost:8080/api/tasks \
  -H "Content-Type: application/json" \
  -d '{"title":"æ–°ã—ã„ã‚¿ã‚¹ã‚¯","description":"èª¬æ˜","assignee_id":"user-001"}'

# ã‚¿ã‚¹ã‚¯ä¸€è¦§å–å¾—
curl http://localhost:8080/api/tasks

# ã‚¿ã‚¹ã‚¯è©³ç´°å–å¾—
curl http://localhost:8080/api/tasks/{task_id}

# ã‚¿ã‚¹ã‚¯æ›´æ–°
curl -X PUT http://localhost:8080/api/tasks/{task_id} \
  -H "Content-Type: application/json" \
  -d '{"title":"æ›´æ–°ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯","status":"IN_PROGRESS"}'

# ã‚¿ã‚¹ã‚¯å‰Šé™¤
curl -X DELETE http://localhost:8080/api/tasks/{task_id}
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†

```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"name":"å±±ç”°å¤ªéƒ","email":"yamada@example.com"}'

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
curl http://localhost:8080/api/users

# ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°å–å¾—
curl http://localhost:8080/api/users/{user_id}
```

## ğŸ” ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã®ç¢ºèª

### Jaeger UIã§ã®ãƒˆãƒ¬ãƒ¼ã‚¹åˆ†æ

1. **Jaeger UI** ã«ã‚¢ã‚¯ã‚»ã‚¹: http://localhost:16686
2. **Service** ã‹ã‚‰ `api-gateway` ã‚’é¸æŠ
3. **Find Traces** ã‚’ã‚¯ãƒªãƒƒã‚¯

### ä¸»è¦ãªè¦³æ¸¬ãƒã‚¤ãƒ³ãƒˆ

- **å‡¦ç†æ™‚é–“**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…¨ä½“ã¨ã‚µãƒ¼ãƒ“ã‚¹é–“ã®å‡¦ç†æ™‚é–“
- **ã‚¨ãƒ©ãƒ¼è¿½è·¡**: ã‚¨ãƒ©ãƒ¼ã®ç™ºç”Ÿå ´æ‰€ã¨ä¼æ’­çµŒè·¯
- **ä¾å­˜é–¢ä¿‚**: ã‚µãƒ¼ãƒ“ã‚¹é–“ã®å‘¼ã³å‡ºã—é–¢ä¿‚
- **ãƒœãƒˆãƒ«ãƒãƒƒã‚¯**: é…ã„å‡¦ç†ã®ç‰¹å®š

### ã‚µãƒ³ãƒ—ãƒ«ãƒˆãƒ¬ãƒ¼ã‚¹

ã‚¿ã‚¹ã‚¯ä½œæˆã®ãƒˆãƒ¬ãƒ¼ã‚¹ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã‚’ç¢ºèªã§ãã¾ã™ï¼š

```
api-gateway/CreateTask
â”œâ”€â”€ task-service/CreateTask
â”‚   â”œâ”€â”€ TaskRepository.CreateTask
â”‚   â”‚   â””â”€â”€ PostgreSQL INSERT
â”‚   â””â”€â”€ user-service/GetUser (ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œè¨¼)
â”‚       â””â”€â”€ cache.Get
â””â”€â”€ Response
```

## ğŸ› ï¸ é–‹ç™ºã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
make help

# é–‹ç™ºç”¨ã‚³ãƒãƒ³ãƒ‰
make build          # ãƒ“ãƒ«ãƒ‰
make test           # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
make lint           # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
make format         # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

# Dockeræ“ä½œ
make up             # ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
make down           # ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
make logs           # ãƒ­ã‚°è¡¨ç¤º
make restart        # ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•

# protobufç”Ÿæˆ
make proto          # gRPCã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
make migrate        # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```

## ğŸ“ˆ å­¦ç¿’ã®ã‚¹ãƒ†ãƒƒãƒ—

### Step 1: åŸºæœ¬çš„ãªãƒˆãƒ¬ãƒ¼ã‚¹ã®ç¢ºèª

1. ã‚·ãƒ³ãƒ—ãƒ«ãªGETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
2. Jaeger UIã§ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ç¢ºèª
3. ã‚¹ãƒ‘ãƒ³ã®éšå±¤æ§‹é€ ã‚’ç†è§£

### Step 2: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®åˆ†æ

```bash
# å­˜åœ¨ã—ãªã„ã‚¿ã‚¹ã‚¯ã‚’å–å¾—ï¼ˆ404ã‚¨ãƒ©ãƒ¼ï¼‰
curl http://localhost:8080/api/tasks/nonexistent

# ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆ400ã‚¨ãƒ©ãƒ¼ï¼‰
curl -X POST http://localhost:8080/api/tasks \
  -H "Content-Type: application/json" \
  -d '{"invalid": "data"}'
```

### Step 3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ

```bash
# å¤§é‡ã®ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
for i in {1..10}; do
  curl -X POST http://localhost:8080/api/tasks \
    -H "Content-Type: application/json" \
    -d "{\"title\":\"ã‚¿ã‚¹ã‚¯$i\",\"assignee_id\":\"user-001\"}"
done

# ãƒªã‚¹ãƒˆå–å¾—ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¢ºèª
curl "http://localhost:8080/api/tasks?page_size=5&page_number=1"
```

### Step 4: åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ç†è§£

ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã§ã€è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹é–“ã§ã®ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å­¦ç¿’ã€‚

## ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã®è¿½åŠ 

1. `proto/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«Protobufã‚¹ã‚­ãƒ¼ãƒã‚’è¿½åŠ 
2. `make proto` ã§Goã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
3. æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
4. `docker-compose.yml` ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ 

### ãƒˆãƒ¬ãƒ¼ã‚¹å±æ€§ã®è¿½åŠ 

```go
span.SetAttributes(
    attribute.String("custom.attribute", "value"),
    attribute.Int("custom.count", 42),
)
```

### ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æˆ¦ç•¥ã®å¤‰æ›´

`tracing/tracer.go` ã® `WithSampler` ã‚’å¤‰æ›´ï¼š

```go
// 50%ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
sdktrace.WithSampler(sdktrace.TraceIDRatioBased(0.5))

// æ¡ä»¶ä»˜ãã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
sdktrace.WithSampler(sdktrace.ParentBased(sdktrace.AlwaysSample()))
```

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ãªã„

```bash
# ãƒãƒ¼ãƒˆã®ç¢ºèª
netstat -tulpn | grep -E ':(8080|8081|8082|5432|16686)'

# Docker ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ç¢ºèª
docker-compose ps

# ãƒ­ã‚°ã®ç¢ºèª
docker-compose logs -f [service-name]
```

### Jaegerã§ãƒˆãƒ¬ãƒ¼ã‚¹ãŒè¡¨ç¤ºã•ã‚Œãªã„

1. **ã‚µãƒ¼ãƒ“ã‚¹åã®ç¢ºèª**: æ­£ã—ã„ã‚µãƒ¼ãƒ“ã‚¹åã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦ã„ã‚‹ã‹
2. **æ™‚é–“ç¯„å›²ã®ç¢ºèª**: é©åˆ‡ãªæ™‚é–“ç¯„å›²ã‚’é¸æŠã—ã¦ã„ã‚‹ã‹
3. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­å®š**: ç’°å¢ƒå¤‰æ•° `JAEGER_ENDPOINT` ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

### PostgreSQLã«æ¥ç¶šã§ããªã„

```bash
# PostgreSQLã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ç¢ºèª
docker-compose exec postgres pg_isready -U otellab

# æ‰‹å‹•æ¥ç¶šãƒ†ã‚¹ãƒˆ
docker-compose exec postgres psql -U otellab -d taskdb
```

## ğŸ“– å‚è€ƒè³‡æ–™

- [OpenTelemetry Documentation](https://opentelemetry.io/docs/)
- [Jaeger Documentation](https://www.jaegertracing.io/docs/)
- [Go gRPC Tutorial](https://grpc.io/docs/languages/go/)
- [åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°å…¥é–€](https://www.oreilly.com/library/view/distributed-tracing-in/9781492056621/)

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

1. ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ•ã‚©ãƒ¼ã‚¯
2. ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ (`git checkout -b feature/amazing-feature`)
3. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ (`git commit -m 'Add some amazing feature'`)
4. ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ (`git push origin feature/amazing-feature`)
5. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ç´°ã¯ [LICENSE](LICENSE) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

**ğŸ‰ Happy Tracing!** 

åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã®ä¸–ç•Œã¸ã‚ˆã†ã“ãï¼è³ªå•ã‚„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã‚ã‚Œã°ã€Issueã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚